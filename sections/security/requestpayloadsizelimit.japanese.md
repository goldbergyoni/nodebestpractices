# Limit payload size using a reverse-proxy or a middleware

### ä¸€æ®µè½èª¬æ˜

JSON ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãªã©ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®ãƒ‘ãƒ¼ã‚¹ã¯ã€ç‰¹ã«å¤§ããªãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çš„ã«é‡ã„å‡¦ç†ã¨ãªã‚Šã¾ã™ã€‚
ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹éš›ã¯ã€ãã‚Œãã‚Œã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ã‚µã‚¤ã‚ºã‚’åˆ¶é™ã™ã‚‹ã¹ãã§ã™ã€‚
ã‚µã‚¤ã‚ºç„¡åˆ¶é™ã®ãƒœãƒ‡ã‚£/ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä»»ã™ã‚‹ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è‘—ã—ãæ‚ªåŒ–ã—ãŸã‚Šã€ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ã«é™¥ã£ãŸã‚Šã€ãã®ã»ã‹æœ›ã¾ãªã„å‰¯ä½œç”¨ã®ãŸã‚ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚
express ã«å«ã¾ã‚Œã¦ã„ã‚‹ `body-parser` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚ˆã†ãªã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’è§£æã™ã‚‹ãŸã‚ã®å¤šãã®ä¸€èˆ¬çš„ãªãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€
ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ã‚µã‚¤ã‚ºã‚’åˆ¶é™ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æä¾›ã—ã¦ãŠã‚Šã€é–‹ç™ºè€…ãŒã“ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã®ã‚’å®¹æ˜“ã«ã—ã¦ã„ã¾ã™ã€‚
ã‚‚ã—ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã®ã§ã‚ã‚Œã°ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚µã‚¤ã‚ºã®åˆ¶é™ã‚’ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·/ã‚¦ã‚§ãƒ–ã‚µãƒ¼ãƒã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã«çµ„ã¿è¾¼ã‚€ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
ä»¥ä¸‹ã«ã€`express` ã‚„ `nginx` ã‚’ç”¨ã„ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚µã‚¤ã‚ºã‚’åˆ¶é™ã™ã‚‹ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚

### `express` ã®ã‚³ãƒ¼ãƒ‰ä¾‹

```javascript
const express = require('express');

const app = express();

app.use(express.json({ limit: '300kb' })); // body-parse ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€100kb ã®ãƒœãƒ‡ã‚£ã‚µã‚¤ã‚ºåˆ¶é™ã§ã™

// json ãƒœãƒ‡ã‚£ã‚’ç”¨ã„ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆ
app.post('/json', (req, res) => {

    // body-parser ã¯ content-type ã‚’ãƒã‚§ãƒƒã‚¯ã—ãªã„ãŸã‚ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã® content-type ãŒ json ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
    if (!req.is('json')) {
        return res.sendStatus(415); // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ JSON ãƒœãƒ‡ã‚£ã‚’æŒã£ã¦ã„ãªã‘ã‚Œã°ã€Unsupported media type ã‚’è¿”ã™
    }

    res.send('Hooray, it worked!');
});

app.listen(3000, () => console.log('Example app listening on port 3000!'));
```

ğŸ”— [**express.json() ã«é–¢ã™ã‚‹ Express ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**](http://expressjs.com/en/4x/api.html#express.json)

### `nginx` ã®è¨­å®šä¾‹

```nginx
http {
    ...
    # ã™ã¹ã¦ã®å—ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒœãƒ‡ã‚£ã‚µã‚¤ã‚ºã‚’ 1MB ã«åˆ¶é™ã™ã‚‹
    client_max_body_size 1m;
}

server {
    ...
    # ã“ã®ç‰¹å®šã®ã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã™ã‚‹å—ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒœãƒ‡ã‚£ã‚µã‚¤ã‚ºã‚’ 1MB ã«åˆ¶é™ã™ã‚‹
    client_max_body_size 1m;
}

location /upload {
    ...
    # ã“ã®ãƒ«ãƒ¼ãƒˆã«å¯¾ã™ã‚‹å—ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒœãƒ‡ã‚£ã‚µã‚¤ã‚ºã‚’ 1MB ã«åˆ¶é™ã™ã‚‹
    client_max_body_size 1m;
}
```

ğŸ”— [**client_max_body_size ã«é–¢ã™ã‚‹ Express ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**](http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size)